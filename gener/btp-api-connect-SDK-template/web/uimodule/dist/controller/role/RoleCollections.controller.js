sap.ui.define(["../BaseController","sap/ui/core/Fragment"],function(e,t){"use strict";return e.extend("com.myorg.myUI5App.controller.role.RoleCollections",{onBeforeRendering:function(){this._setDefault()},_setDefault:function(){this.onFCLOneColumn();let e=this.getView();e.setModel(new sap.ui.model.json.JSONModel,"users");e.setModel(new sap.ui.model.json.JSONModel,"collections");e.setModel(new sap.ui.model.json.JSONModel(this.getRoleTemplate()),"collection");e.setModel(new sap.ui.model.json.JSONModel,"roles");e.setModel(new sap.ui.model.json.JSONModel({state:"Create"}),"state");this._usersModel=e.getModel("users");this._collectionsModel=e.getModel("collections");this._collectionModel=e.getModel("collection");this._rolesModel=e.getModel("roles");this._state=e.getModel("state");this._FCL=e.byId("fcl");this._collectionTable=e.byId("collectionTable");this.getRoleCollections();this.getRoles();this.getUsers()},getUsers:function(){this.callSDK("GET","/app/users",undefined,this.setUsers)},setUsers:function(e){this._users=e.resources;this._usersModel.setProperty("/",e)},getRoleCollections:function(){this.callSDK("GET","/app/role-collection",undefined,this.setRoleCollections)},setRoleCollections:function(e,t){this.csrfToken=t.getResponseHeader("X-CSRF-Token");this._collectionsModel.setProperty("/",e);if(this._collectionPath)this.setRoleCollection()},setRoleCollection:function(){let e=this._collectionsModel.getProperty(this._collectionPath);this._collectionModel.setProperty("/",e)},getRoles:function(){this.callSDK("GET","/app/roles",undefined,this.setRoles)},setRoles:function(e,t){this._roles=e;this.csrfToken=t.getResponseHeader("X-CSRF-Token");this._rolesModel.setProperty("/",e)},getRoleTemplate:function(){return{name:"",description:""}},onSearch:function(e){let t=this._collectionTable.getBinding("items");let o=e.getParameter("query");let l=[];if(o){l.push(new sap.ui.model.Filter("name","Contains",o))}t.filter([l])},onOpenDialog:function(e){let o=this.getView();let l=this.getCustomDataKey(e.getSource());let i=this.getCustomDataValue(e.getSource());this._dialogName=l;switch(i){case"Create":this._collectionModel.setProperty("/",this.getRoleTemplate());this._FCL.getLayout()!=="OneColumn"?this.onFCLOneColumn():"";this._state.setProperty("/state","Create");break;case"Edit":this._state.setProperty("/state","Edit");break;case"addUser":let e=this._users;let t=this._collectionModel.getProperty("/userReferences");if(t){let o=e.filter(e=>{let o=t.findIndex(t=>e.id===t.id);if(o>-1)return false;return true});this._usersModel.setProperty("/resources",o);break}this._usersModel.setProperty("/resources",e);break;case"addRole":let o=this._roles;let l=this._collectionModel.getProperty("/roleReferences");if(l){let e=o.filter(e=>{let t=l.findIndex(t=>e.name===t.name);if(t>-1)return false;return true});this._rolesModel.setProperty("/",e);break}this._rolesModel.setProperty("/",o);break}if(!this[l]){this[l]=t.load({id:this.getView().getId(),name:`com.myorg.myUI5App.view.role.dialog.${l}`,controller:this})}this[l].then(e=>{o.addDependent(e);e.open()})},onClose:function(){let e=this._dialogName;this[e].then(e=>e.close())},onSubmit:function(){let e=this.getView().byId("collectionForm");if(!this.validationCheck(e))return;let t=this._collectionModel.getProperty("/");if(this._state.getProperty("/state")==="Create"){this.createCollection(t)}else{this.editCollection(t)}this.onClose()},createCollection:function(e){this.callSDK("POST","/app/role-collection",e,this.getRoleCollections)},editCollection:function({name:e,description:t}){let o={id:e,collection:{description:t}};this.callSDK("PUT","/app/role-collection",o,this.getRoleCollections)},onCollectionsItemPress:function(e){let t=this.getView();let o=t.byId("addRoleBtn");let l=t.byId("roleTable");let i=e.getParameter("listItem");let s=i.getBindingContextPath("collections");let n=this._collectionsModel.getProperty(s);this._collectionModel.setProperty("/",n);this._collectionPath=s;this._FCL.getLayout()==="OneColumn"?this.onFCLTwoColumn():"";if(n.isReadOnly){o.setVisible(false);l.setMode("None");return}l.setMode("Delete");o.setVisible(true)},deleteRoleCollection:async function(){let e=this._collectionModel.getProperty("/name");let t=await this.showWarningBox();if(t){this.callSDK("DELETE","/app/role-collection",{id:e},this.getRoleCollections);this.onFCLOneColumn()}},onAddUserCollection:function(e){let t=e.getParameter("selectedItems");let o=t.map(e=>e.getTitle());let l=this._collectionModel.getProperty("/name");o.forEach(e=>{let t={id:l,group:{type:"USER",value:e,origin:"sap.default"}};this.callSDK("POST","/app/group",t,this.getRoleCollections)})},deleteCollectionUser:async function(e){let t=e.getParameter("listItem");let o=await this.showWarningBox();if(o){let e={groupId:this._collectionModel.getProperty("/name"),userId:this._collectionModel.getProperty(`${t.getBindingContextPath("collection")}/id`)};this.callSDK("DELETE","/app/group",e,this.getRoleCollections)}},onRolesSearch:function(e){let t=e.getParameter("value");let o=new sap.ui.model.Filter("name","Contains",t);let l=e.getParameter("itemsBinding");l.filter([o])},onDeleteRoleFromRoleCollection:async function(e){let t=e.getParameter("listItem");let o=await this.showWarningBox();let l=t.getBindingContextPath("collection");if(o){let e=this._collectionModel.getProperty(l);let t=this._collectionModel.getProperty("/name");let o={roleCollectionName:t,roleName:e.name,roleTemplateAppId:e.roleTemplateAppId,roleTemplateName:e.roleTemplateName};this.callSDK("DELETE","/app/role-collection/role",o,this.getRoleCollections)}},addRolesToRoleCollection:function(e){let t=e.getParameter("selectedItems");let o={collectionName:this._collectionModel.getProperty("/name"),roleReference:[]};t.forEach(e=>{let t=e.getBindingContextPath("roles");let l=this._rolesModel.getProperty(t);let i={description:l.description,name:l.name,roleTemplateAppId:l.roleTemplateAppId,roleTemplateName:l.roleTemplateName};o.roleReference.push(i)});this.callSDK("PUT","/app/role-collection/role",o,this.getRoleCollections)}})});